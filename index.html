<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Sistema de Controle de Filamentos e Impress√µes 3D</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f172a;
      --bg-soft: #020617;
      --card: #020617;
      --accent: #3b82f6;
      --accent-soft: rgba(59, 130, 246, 0.12);
      --accent-border: rgba(59, 130, 246, 0.4);
      --accent-hover: #2563eb;
      --danger: #ef4444;
      --danger-soft: rgba(239, 68, 68, 0.12);
      --text: #e5e7eb;
      --text-soft: #9ca3af;
      --border: #1f2937;
      --radius-lg: 14px;
      --radius-md: 10px;
      --radius-pill: 999px;
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.9);
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at top, #1d4ed8 0, #020617 40%, #000 100%);
      color: var(--text);
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 24px;
    }

    .app-shell {
      width: 100%;
      max-width: 1320px;
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.98));
      border-radius: 24px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .app-header {
      padding: 18px 24px 12px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.18);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    .app-title-block {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .logo-circle {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 20%, #60a5fa, #1d4ed8, #020617);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 18px;
      color: white;
      box-shadow: 0 0 18px rgba(59, 130, 246, 0.9);
    }

    .app-title-text h1 {
      margin: 0;
      font-size: 18px;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: #e5e7eb;
    }

    .app-title-text span {
      display: block;
      font-size: 11px;
      color: var(--text-soft);
      text-transform: uppercase;
      letter-spacing: 0.14em;
      margin-top: 2px;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .pill {
      border-radius: var(--radius-pill);
      border: 1px solid rgba(148, 163, 184, 0.2);
      padding: 6px 12px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--text-soft);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(15, 23, 42, 0.8);
    }

    .pill-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.25);
    }

    .btn-primary,
    .btn-ghost,
    .btn-danger {
      border-radius: var(--radius-pill);
      padding: 8px 14px;
      font-size: 12px;
      border: 1px solid transparent;
      background: none;
      color: var(--text);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.16s ease-out;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(120deg, #2563eb, #3b82f6);
      border-color: rgba(59, 130, 246, 0.6);
      box-shadow: 0 12px 25px rgba(37, 99, 235, 0.45);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      background: linear-gradient(120deg, #1d4ed8, #2563eb);
      box-shadow: 0 14px 30px rgba(37, 99, 235, 0.6);
    }

    .btn-ghost {
      border-color: rgba(148, 163, 184, 0.35);
      color: var(--text-soft);
      background: rgba(15, 23, 42, 0.6);
    }

    .btn-ghost:hover {
      border-color: rgba(148, 163, 184, 0.7);
      color: #e5e7eb;
      background: rgba(15, 23, 42, 0.9);
    }

    .btn-danger {
      border-color: rgba(239, 68, 68, 0.6);
      color: #fecaca;
      background: var(--danger-soft);
    }

    .btn-danger:hover {
      background: rgba(239, 68, 68, 0.18);
    }

    .btn-icon {
      font-size: 14px;
      line-height: 0;
    }

    .app-body {
      display: grid;
      grid-template-columns: 260px 1fr;
      min-height: 520px;
    }

    @media (max-width: 960px) {
      body {
        padding: 12px;
      }

      .app-body {
        grid-template-columns: 1fr;
      }
    }

    .sidebar {
      border-right: 1px solid rgba(148, 163, 184, 0.18);
      padding: 16px 14px 18px;
      background: radial-gradient(circle at top left, rgba(37, 99, 235, 0.2), transparent 55%),
        radial-gradient(circle at bottom, rgba(15, 23, 42, 1), rgba(15, 23, 42, 1));
    }

    .nav-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: var(--text-soft);
      margin-bottom: 8px;
      padding-inline: 4px;
    }

    .nav-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 16px;
    }

    .nav-item {
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 13px;
      color: var(--text-soft);
      border: 1px solid transparent;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      background: transparent;
      transition: all 0.15s ease-out;
    }

    .nav-item-main {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .nav-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.65);
    }

    .nav-label {
      font-size: 13px;
    }

    .nav-pill {
      font-size: 11px;
      color: var(--text-soft);
      background: rgba(15, 23, 42, 0.72);
      border-radius: 999px;
      padding: 3px 7px;
      border: 1px solid rgba(148, 163, 184, 0.3);
    }

    .nav-item.active {
      background: linear-gradient(
        100deg,
        rgba(37, 99, 235, 0.23),
        rgba(15, 23, 42, 0.95)
      );
      border-color: rgba(59, 130, 246, 0.7);
      color: #e5e7eb;
    }

    .nav-item.active .nav-dot {
      background: #3b82f6;
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.35);
    }

    .sidebar-footer {
      margin-top: 16px;
      padding: 10px 10px 6px;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.2), transparent 65%);
      font-size: 11px;
      color: var(--text-soft);
    }

    .sidebar-footer strong {
      color: #e5e7eb;
      font-weight: 600;
    }

    .content {
      padding: 16px 18px 18px;
      background: radial-gradient(circle at top right, rgba(30, 64, 175, 0.5), transparent 55%),
        radial-gradient(circle at bottom, #020617, #020617);
    }

    .content-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
    }

    .content-title-block h2 {
      margin: 0;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .content-title-block span {
      display: block;
      font-size: 12px;
      color: var(--text-soft);
      margin-top: 2px;
    }

    .badge {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(59, 130, 246, 0.6);
      background: rgba(15, 23, 42, 0.8);
      color: #93c5fd;
    }

    .content-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .content-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.3fr);
      gap: 14px;
    }

    @media (max-width: 1100px) {
      .content-grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.98));
      border-radius: var(--radius-lg);
      border: 1px solid rgba(148, 163, 184, 0.26);
      padding: 12px 14px 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 120px;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .card-title {
      font-size: 13px;
      font-weight: 600;
      color: #e5e7eb;
    }

    .card-subtitle {
      font-size: 11px;
      color: var(--text-soft);
    }

    .field-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 8px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 12px;
    }

    .field label {
      color: var(--text-soft);
      font-size: 11px;
    }

    .field input,
    .field select {
      border-radius: var(--radius-md);
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(15, 23, 42, 0.9);
      padding: 7px 8px;
      color: var(--text);
      font-size: 12px;
      outline: none;
      transition: border-color 0.15s ease-out, box-shadow 0.15s ease-out,
        background 0.15s ease-out;
    }

    .field input:focus,
    .field select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.7);
      background: rgba(15, 23, 42, 1);
    }

    .field input[type="number"]::-webkit-inner-spin-button,
    .field input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .field input[type="number"] {
      -moz-appearance: textfield;
    }

    .table-wrapper {
      border-radius: var(--radius-lg);
      border: 1px solid rgba(148, 163, 184, 0.3);
      background: radial-gradient(circle at top left, rgba(37, 99, 235, 0.22), transparent 60%),
        rgba(15, 23, 42, 0.96);
      overflow: hidden;
      max-height: 290px;
      display: flex;
      flex-direction: column;
    }

    .table-wrapper-header {
      padding: 8px 10px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--text-soft);
      border-bottom: 1px solid rgba(148, 163, 184, 0.3);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .table-scroll {
      overflow: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      min-width: 520px;
    }

    th,
    td {
      padding: 6px 8px;
      text-align: left;
      border-bottom: 1px solid rgba(30, 41, 59, 0.9);
      white-space: nowrap;
    }

    th {
      font-size: 11px;
      color: var(--text-soft);
      text-transform: uppercase;
      letter-spacing: 0.09em;
      background: rgba(15, 23, 42, 0.96);
      position: sticky;
      top: 0;
      z-index: 2;
    }

    tr:hover td {
      background: rgba(15, 23, 42, 0.8);
    }

    .tag {
      border-radius: 999px;
      padding: 2px 7px;
      font-size: 11px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.85);
      color: var(--text-soft);
    }

    .tag-ml {
      border-color: rgba(245, 158, 11, 0.7);
      color: #fbbf24;
    }

    .tag-shopee {
      border-color: rgba(248, 113, 113, 0.8);
      color: #fb7185;
    }

    .tag-amazon {
      border-color: rgba(52, 211, 153, 0.8);
      color: #6ee7b7;
    }

    .tag-magalu {
      border-color: rgba(96, 165, 250, 0.8);
      color: #93c5fd;
    }

    .status-pill {
      border-radius: 999px;
      padding: 2px 7px;
      font-size: 11px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      text-transform: uppercase;
      letter-spacing: 0.09em;
    }

    .status-todo {
      border-color: rgba(148, 163, 184, 0.6);
      color: #e5e7eb;
    }

    .status-printing {
      border-color: rgba(59, 130, 246, 0.7);
      color: #93c5fd;
      background: rgba(37, 99, 235, 0.12);
    }

    .status-ready {
      border-color: rgba(52, 211, 153, 0.7);
      color: #6ee7b7;
      background: rgba(16, 185, 129, 0.14);
    }

    .status-sent {
      border-color: rgba(34, 197, 94, 0.8);
      color: #bbf7d0;
      background: rgba(22, 163, 74, 0.16);
    }

    .status-cancelled {
      border-color: rgba(239, 68, 68, 0.9);
      color: #fecaca;
      background: rgba(239, 68, 68, 0.18);
    }

    .status-returned {
      border-color: rgba(248, 113, 113, 0.9);
      color: #fed7d7;
      background: rgba(248, 113, 113, 0.18);
    }

    .kpi-row {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 8px;
    }

    @media (max-width: 900px) {
      .kpi-row {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 600px) {
      .kpi-row {
        grid-template-columns: 1fr;
      }
    }

    .kpi-card {
      border-radius: var(--radius-lg);
      border: 1px solid rgba(148, 163, 184, 0.3);
      background: radial-gradient(circle at top left, rgba(37, 99, 235, 0.25), transparent 60%),
        rgba(15, 23, 42, 0.96);
      padding: 8px 9px;
    }

    .kpi-label {
      font-size: 11px;
      color: var(--text-soft);
      text-transform: uppercase;
      letter-spacing: 0.13em;
      margin-bottom: 4px;
    }

    .kpi-value {
      font-size: 18px;
      font-weight: 600;
      color: #e5e7eb;
    }

    .kpi-sub {
      font-size: 11px;
      color: var(--text-soft);
      margin-top: 2px;
    }

    .muted {
      color: var(--text-soft);
      font-size: 11px;
    }

    .text-right {
      text-align: right;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header class="app-header">
      <div class="app-title-block">
        <div class="logo-circle">3D</div>
        <div class="app-title-text">
          <h1>Controle 3D ‚Ä¢ Langeloh</h1>
          <span>Filamentos ‚Ä¢ Impress√µes ‚Ä¢ Vendas ‚Ä¢ KPIs</span>
        </div>
      </div>
      <div class="header-actions">
        <div class="pill">
          <span class="pill-dot"></span>
          Local Storage
        </div>
        <button class="btn-ghost" id="btnSyncMl">
          <span class="btn-icon">üîÑ</span> Sincronizar Mercado Livre
        </button>
      </div>
    </header>

    <div class="app-body">
      <!-- SIDEBAR -->
      <aside class="sidebar">
        <div class="nav-title">Navega√ß√£o</div>
        <div class="nav-list">
          <button class="nav-item active" data-tab="cadastros">
            <div class="nav-item-main">
              <div class="nav-dot"></div>
              <span class="nav-label">Filamentos & Produtos</span>
            </div>
            <span class="nav-pill">Base</span>
          </button>
          <button class="nav-item" data-tab="vendas">
            <div class="nav-item-main">
              <div class="nav-dot"></div>
              <span class="nav-label">Vendas</span>
            </div>
            <span class="nav-pill">Entrada</span>
          </button>
          <button class="nav-item" data-tab="fila">
            <div class="nav-item-main">
              <div class="nav-dot"></div>
              <span class="nav-label">Fila de Impress√£o</span>
            </div>
            <span class="nav-pill">Produ√ß√£o</span>
          </button>
          <button class="nav-item" data-tab="impressoes">
            <div class="nav-item-main">
              <div class="nav-dot"></div>
              <span class="nav-label">Registro de Impress√µes</span>
            </div>
            <span class="nav-pill">M√°quinas</span>
          </button>
          <button class="nav-item" data-tab="relatorios">
            <div class="nav-item-main">
              <div class="nav-dot"></div>
              <span class="nav-label">Relat√≥rios & KPIs</span>
            </div>
            <span class="nav-pill">Gest√£o</span>
          </button>
        </div>

        <div class="sidebar-footer">
          <strong>Lembrete:</strong> Este sistema funciona totalmente offline usando LocalStorage.
        </div>
      </aside>

      <!-- MAIN CONTENT -->
      <main class="content">
        <!-- CADASTROS -->
        <section class="tab-panel" id="tab-cadastros">
          <div class="content-header">
            <div class="content-title-block">
              <h2>
                Filamentos & Produtos
                <span class="badge">Cadastro base</span>
              </h2>
              <span>Cadastre filamentos com custo e estoque, e os SKUs 3D da opera√ß√£o.</span>
            </div>
          </div>

          <div class="content-grid">
            <!-- CAD FILAMENTOS -->
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Cadastro de Filamentos</div>
                  <div class="card-subtitle">
                    Cor, material, marca, custo/kg e estoque.
                  </div>
                </div>
                <button class="btn-primary" id="btnAddFilament">
                  <span class="btn-icon">‚ûï</span> Adicionar
                </button>
              </div>

              <div class="field-grid">
                <div class="field">
                  <label>Cor</label>
                  <input type="text" id="filCor" placeholder="Ex: OFF WHITE" />
                </div>
                <div class="field">
                  <label>Material</label>
                  <input type="text" id="filMaterial" placeholder="PLA, PETG..." />
                </div>
                <div class="field">
                  <label>Marca</label>
                  <input type="text" id="filMarca" placeholder="FullJoy, 3DFila..." />
                </div>
                <div class="field">
                  <label>Pre√ßo por kg (R$)</label>
                  <input type="number" step="0.01" id="filPrecoKg" />
                </div>
                <div class="field">
                  <label>Quantidade comprada (kg)</label>
                  <input type="number" step="0.01" id="filQtdComprada" />
                </div>
                <div class="field">
                  <label>Estoque atual (kg)</label>
                  <input type="number" step="0.01" id="filEstoque" />
                </div>
              </div>

              <div class="table-wrapper" style="margin-top: 8px;">
                <div class="table-wrapper-header">
                  <span>Filamentos cadastrados</span>
                  <span class="muted" id="filamentosResumo"></span>
                </div>
                <div class="table-scroll">
                  <table id="tabelaFilamentos">
                    <thead>
                      <tr>
                        <th>Cor</th>
                        <th>Material</th>
                        <th>Marca</th>
                        <th>Pre√ßo/kg</th>
                        <th>Comprado (kg)</th>
                        <th>Estoque (kg)</th>
                        <th>A√ß√µes</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- CAD PRODUTOS -->
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Cadastro de Produtos 3D</div>
                  <div class="card-subtitle">
                    SKU, nome, cor padr√£o, custo m√©dio de impress√£o e estoque.
                  </div>
                </div>
                <button class="btn-primary" id="btnAddProduto">
                  <span class="btn-icon">‚ûï</span> Adicionar
                </button>
              </div>

              <div class="field-grid">
                <div class="field">
                  <label>SKU</label>
                  <input
                    type="text"
                    id="prodSku"
                    placeholder="Ex: 1UFAMILIA3D (contendo 3D)"
                  />
                </div>
                <div class="field">
                  <label>Nome</label>
                  <input type="text" id="prodNome" placeholder="Ex: FAM√çLIA 3D" />
                </div>
                <div class="field">
                  <label>Cor padr√£o (opcional)</label>
                  <input type="text" id="prodCorPadrao" placeholder="Ex: OFF WHITE" />
                </div>
                <div class="field">
                  <label>Custo m√©dio de impress√£o (R$)</label>
                  <input type="number" step="0.01" id="prodCustoMedio" />
                </div>
                <div class="field">
                  <label>Estoque atual (un.)</label>
                  <input type="number" step="1" id="prodEstoque" />
                </div>
              </div>

              <div class="table-wrapper" style="margin-top: 8px;">
                <div class="table-wrapper-header">
                  <span>Produtos cadastrados</span>
                  <span class="muted" id="produtosResumo"></span>
                </div>
                <div class="table-scroll">
                  <table id="tabelaProdutos">
                    <thead>
                      <tr>
                        <th>SKU</th>
                        <th>Nome</th>
                        <th>Cor padr√£o</th>
                        <th>Custo m√©dio (R$)</th>
                        <th>Estoque</th>
                        <th>3D?</th>
                        <th>A√ß√µes</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- VENDAS -->
        <section class="tab-panel" id="tab-vendas" style="display:none;">
          <div class="content-header">
            <div class="content-title-block">
              <h2>
                Vendas
                <span class="badge">Entrada de pedidos</span>
              </h2>
              <span>
                Registro manual por enquanto. Quando a integra√ß√£o estiver 100%, as vendas da ML entram aqui sozinhas.
              </span>
            </div>
          </div>

          <div class="content-grid">
            <!-- FORM DE VENDA -->
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Cadastro de Venda</div>
                  <div class="card-subtitle">
                    Cada venda j√° entra com status "A fazer" na fila de impress√£o.
                  </div>
                </div>
                <button class="btn-primary" id="btnAddVenda">
                  <span class="btn-icon">‚ûï</span> Adicionar
                </button>
              </div>

              <div class="field-grid">
                <div class="field">
                  <label>SKU do produto</label>
                  <input type="text" id="venSku" placeholder="SKU exato" />
                </div>
                <div class="field">
                  <label>Nome do produto (opcional)</label>
                  <input type="text" id="venNome" placeholder="Se n√£o souber, deixa em branco" />
                </div>
                <div class="field">
                  <label>Marketplace</label>
                  <select id="venMarketplace">
                    <option value="mercadolivre">Mercado Livre</option>
                    <option value="shopee">Shopee</option>
                    <option value="amazon">Amazon</option>
                    <option value="magalu">Magalu</option>
                    <option value="outro">Outro</option>
                  </select>
                </div>
                <div class="field">
                  <label>Cor do filamento</label>
                  <select id="venCor">
                    <option value="">Selecione (vem dos filamentos)</option>
                  </select>
                </div>
                <div class="field">
                  <label>Pre√ßo de venda (R$)</label>
                  <input type="number" step="0.01" id="venPreco" />
                </div>
                <div class="field">
                  <label>Quantidade</label>
                  <input type="number" step="1" id="venQtd" value="1" />
                </div>
                <div class="field">
                  <label>Data da venda</label>
                  <input type="date" id="venDataVenda" />
                </div>
                <div class="field">
                  <label>Data limite de envio</label>
                  <input type="date" id="venDataEnvio" />
                </div>
              </div>

              <p class="muted">
                Campos de taxa, imposto, frete e KPI de lucratividade vir√£o da l√≥gica que j√° definimos.
              </p>
            </div>

            <!-- LISTA DE VENDAS -->
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Vendas cadastradas</div>
                  <div class="card-subtitle">
                    Status e destino na fila de impress√£o.
                  </div>
                </div>
              </div>

              <div class="field-grid" style="margin-bottom: 6px;">
                <div class="field">
                  <label>Filtrar marketplace</label>
                  <select id="filtroVendaMarketplace">
                    <option value="">Todos</option>
                    <option value="mercadolivre">Mercado Livre</option>
                    <option value="shopee">Shopee</option>
                    <option value="amazon">Amazon</option>
                    <option value="magalu">Magalu</option>
                    <option value="outro">Outro</option>
                  </select>
                </div>
                <div class="field">
                  <label>Filtrar status</label>
                  <select id="filtroVendaStatus">
                    <option value="">Todos</option>
                    <option value="afazer">A fazer</option>
                    <option value="emimpressao">Em impress√£o</option>
                    <option value="pronto">Pronto</option>
                    <option value="enviado">Enviado</option>
                    <option value="cancelado">Cancelado</option>
                    <option value="devolvido">Devolvido</option>
                  </select>
                </div>
              </div>

              <div class="table-wrapper">
                <div class="table-wrapper-header">
                  <span>Vendas (LocalStorage)</span>
                  <span class="muted" id="vendasResumo"></span>
                </div>
                <div class="table-scroll">
                  <table id="tabelaVendas">
                    <thead>
                      <tr>
                        <th>SKU</th>
                        <th>Nome</th>
                        <th>Marketplace</th>
                        <th>Pre√ßo (R$)</th>
                        <th>Qtd</th>
                        <th>Status</th>
                        <th>Envio</th>
                        <th>A√ß√µes</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- FILA -->
        <section class="tab-panel" id="tab-fila" style="display:none;">
          <div class="content-header">
            <div class="content-title-block">
              <h2>
                Fila de Impress√£o
                <span class="badge">Prioridade por envio</span>
              </h2>
              <span>
                Aqui entram automaticamente as vendas com status "A fazer".
              </span>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">Filtros da fila</div>
                <div class="card-subtitle">
                  Combine marketplace, tipo (3D/Outros) e status.
                </div>
              </div>
            </div>

            <div class="field-grid">
              <div class="field">
                <label>Marketplace</label>
                <select id="filtroFilaMarketplace">
                  <option value="">Todos</option>
                  <option value="mercadolivre">Mercado Livre</option>
                  <option value="shopee">Shopee</option>
                  <option value="amazon">Amazon</option>
                  <option value="magalu">Magalu</option>
                  <option value="outro">Outro</option>
                </select>
              </div>
              <div class="field">
                <label>Produto (3D x Outros)</label>
                <select id="filtroFilaTipo">
                  <option value="">Todos</option>
                  <option value="3d">Apenas 3D (SKU com '3D')</option>
                  <option value="outros">Outros</option>
                </select>
              </div>
              <div class="field">
                <label>Status da impress√£o</label>
                <select id="filtroFilaStatus">
                  <option value="">Todos</option>
                  <option value="afazer">A fazer</option>
                  <option value="emimpressao">Em impress√£o</option>
                  <option value="pronto">Pronto</option>
                  <option value="enviado">Enviado</option>
                  <option value="cancelado">Cancelado</option>
                  <option value="devolvido">Devolvido</option>
                </select>
              </div>
            </div>

            <div class="table-wrapper" style="margin-top: 8px;">
              <div class="table-wrapper-header">
                <span>Itens na fila</span>
                <span class="muted" id="filaResumo"></span>
              </div>
              <div class="table-scroll">
                <table id="tabelaFila">
                  <thead>
                    <tr>
                      <th>SKU</th>
                      <th>Produto</th>
                      <th>Marketplace</th>
                      <th>Cor</th>
                      <th>Qtd</th>
                      <th>Envio</th>
                      <th>Status</th>
                      <th>A√ß√µes</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </section>

        <!-- IMPRESS√ïES (simples, por enquanto) -->
        <section class="tab-panel" id="tab-impressoes" style="display:none;">
          <div class="content-header">
            <div class="content-title-block">
              <h2>
                Registro de Impress√µes
                <span class="badge">Custo real</span>
              </h2>
              <span>
                Registro simples de impress√µes com tempo, gramas e custo de energia.
              </span>
            </div>
          </div>

          <div class="content-grid">
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Nova impress√£o</div>
                  <div class="card-subtitle">
                    Liga√ß√£o com vendas/fila e desperd√≠cio detalhado a gente aprofunda na pr√≥xima vers√£o.
                  </div>
                </div>
                <button class="btn-primary" id="btnRegistrarImpressao">
                  <span class="btn-icon">üíæ</span> Registrar
                </button>
              </div>

              <div class="field-grid">
                <div class="field">
                  <label>Nome opcional da impress√£o</label>
                  <input type="text" id="impNomeOpcional" placeholder="Ex: Batch fam√≠lia 3D" />
                </div>
                <div class="field">
                  <label>Impressora</label>
                  <select id="impImpressora">
                    <option value="bambu_a1_1">Bambu Lab A1 #1</option>
                    <option value="bambu_a1_2">Bambu Lab A1 #2</option>
                    <option value="bambu_a1_3">Bambu Lab A1 #3</option>
                    <option value="bambu_x1">Bambu Lab X1 Carbon</option>
                  </select>
                </div>
                <div class="field">
                  <label>Cor do filamento</label>
                  <select id="impCor">
                    <option value="">Selecione</option>
                  </select>
                </div>
                <div class="field">
                  <label>Gramas usadas (g)</label>
                  <input type="number" step="0.1" id="impGramas" />
                </div>
                <div class="field">
                  <label>Tempo de impress√£o (minutos)</label>
                  <input type="number" step="1" id="impTempoMin" />
                </div>
                <div class="field">
                  <label>Status da impress√£o</label>
                  <select id="impStatus">
                    <option value="sucesso">Sucesso</option>
                    <option value="erro">Erro total</option>
                    <option value="erroparcial">Erro parcial</option>
                  </select>
                </div>
              </div>

              <p class="muted">
                Custo de energia calculado com base em 0,2 kWh por hora e R$ 0,95/kWh.
              </p>
            </div>

            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Hist√≥rico de Impress√µes</div>
                  <div class="card-subtitle">
                    Impress√µes registrados no LocalStorage.
                  </div>
                </div>
              </div>

              <div class="table-wrapper">
                <div class="table-wrapper-header">
                  <span>Impress√µes</span>
                  <span class="muted" id="impressoesResumo"></span>
                </div>
                <div class="table-scroll">
                  <table id="tabelaImpressoes">
                    <thead>
                      <tr>
                        <th>Nome</th>
                        <th>Impressora</th>
                        <th>Cor</th>
                        <th>Gramas</th>
                        <th>Tempo (min)</th>
                        <th>Status</th>
                        <th>Custo energia (R$)</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- RELAT√ìRIOS (simples, placeholder) -->
        <section class="tab-panel" id="tab-relatorios" style="display:none;">
          <div class="content-header">
            <div class="content-title-block">
              <h2>
                Relat√≥rios & KPIs
                <span class="badge">Vis√£o geral</span>
              </h2>
              <span>
                Aqui vamos concentrar KPIs de filamento gasto, estoque, devolu√ß√µes e lucratividade.
              </span>
            </div>
          </div>

          <div class="card">
            <div class="kpi-row">
              <div class="kpi-card">
                <div class="kpi-label">Filamento total comprado (kg)</div>
                <div class="kpi-value" id="kpiFilamentoComprado">0</div>
                <div class="kpi-sub">Soma de todos os filamentos cadastrados</div>
              </div>
              <div class="kpi-card">
                <div class="kpi-label">Filamento em estoque (kg)</div>
                <div class="kpi-value" id="kpiFilamentoEstoque">0</div>
                <div class="kpi-sub">Atualizado conforme impress√µes (pr√≥xima itera√ß√£o)</div>
              </div>
              <div class="kpi-card">
                <div class="kpi-label">Qtd. vendas 3D</div>
                <div class="kpi-value" id="kpiVendas3D">0</div>
                <div class="kpi-sub">Baseado em SKU contendo "3D"</div>
              </div>
              <div class="kpi-card">
                <div class="kpi-label">Qtd. devolu√ß√µes</div>
                <div class="kpi-value" id="kpiDevolucoes">0</div>
                <div class="kpi-sub">Vendas com status "devolvido"</div>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- JS: L√ìGICA DO SISTEMA -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import {
      getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, getDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyBQ-3TW0z2K7M3eSar21e8evWnJCRk9NBw",
      authDomain: "dados-controle-de-filamento.firebaseapp.com",
      projectId: "dados-controle-de-filamento",
      storageBucket: "dados-controle-de-filamento.firebasestorage.app",
      messagingSenderId: "72506766646",
      appId: "1:72506766646:web:77c16bb0c3a1990b0fcef97"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Offline queue
    const QUEUE_KEY = "controle3d_queue_v1";
    function readQueue() { try { return JSON.parse(localStorage.getItem(QUEUE_KEY) || '[]'); } catch { return []; } }
    function writeQueue(queue) { try { localStorage.setItem(QUEUE_KEY, JSON.stringify(queue)); } catch {} }
    async function flushQueue() {
      const queue = readQueue();
      if (!queue.length) return;
      const pending = [];
      for (const op of queue) {
        try {
          if (op.type === "add") await addDoc(collection(db, op.col), op.data);
          else if (op.type === "update") await updateDoc(doc(db, op.col, op.id), op.data);
          else if (op.type === "delete") await deleteDoc(doc(db, op.col, op.id));
        } catch { pending.push(op); }
      }
      writeQueue(pending);
    }

    function queueOp(type, col, id, data) {
      readQueue().push({ type, col, id, data });
      writeQueue(readQueue());
      flushQueue();
    }

    // Tab nav
    document.querySelectorAll('.nav-item').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.tab-panel').forEach(p => p.style.display = p.id === `tab-${btn.dataset.tab}` ? 'block' : 'none');
        flushQueue();
      };
    });

    // Helpers
    const marketplaceTags = {
      mercadolivre: 'tag-ml', shopee: 'tag-shopee', amazon: 'tag-amazon', magalu: 'tag-magalu'
    };
    function marketplaceTag(mp) {
      const cl = marketplaceTags[mp] || '';
      return `<span class="tag ${cl}">${mp === 'mercadolivre' ? 'ML' : mp.slice(0,1).toUpperCase()}</span>`;
    }
    const statusMap = {
      afazer: {cls: 'status-todo', lbl: 'A FAZER'},
      emimpressao: {cls: 'status-printing', lbl: 'EM IMPRESS√ÉO'},
      pronto: {cls: 'status-ready', lbl: 'PRONTO'},
      enviado: {cls: 'status-sent', lbl: 'ENVIADO'},
      cancelado: {cls: 'status-cancelled', lbl: 'CANCELADO'},
      devolvido: {cls: 'status-returned', lbl: 'DEVOLVIDO'}
    };
    function statusPill(st) {
      const i = statusMap[st] || {cls: 'status-todo', lbl: st || '?'};
      return `<span class="status-pill ${i.cls}">${i.lbl}</span>`;
    }

    // FILAMENTS
    document.getElementById('btnAddFilament').onclick = () => {
      const data = {
        cor: document.getElementById('filCor').value.trim(),
        material: document.getElementById('filMaterial').value.trim(),
        marca: document.getElementById('filMarca').value.trim(),
        precoKg: parseFloat(document.getElementById('filPrecoKg').value || 0),
        qtdComprada: parseFloat(document.getElementById('filQtdComprada').value || 0),
        estoqueKg: parseFloat(document.getElementById('filEstoque').value || 0),
        createdAt: serverTimestamp()
      };
      if (!data.cor) return alert('Cor obrigat√≥ria');
      queueOp('add', 'filaments', null, data);
      document.querySelectorAll('[id^=fil]').forEach(el => el.value = '');
    };

    onSnapshot(collection(db, 'filaments'), snap => {
      const tbody = document.querySelector('#tabelaFilamentos tbody');
      const resumo = document.getElementById('filamentosResumo');
      const selVenda = document.getElementById('venCor');
      const selImp = document.getElementById('impCor');
      tbody.innerHTML = '';
      selVenda.innerHTML = '<option value="">Selecione</option>';
      selImp.innerHTML = '<option value="">Selecione</option>';
      let totC = 0, totE = 0;
      snap.forEach(d => {
        const f = d.data();
        totC += f.qtdComprada || 0;
        totE += f.estoqueKg || 0;
        const tr = document.createElement('tr');
        tr.innerHTML = `
<td>${f.cor}</td><td>${f.material||''}</td><td>${f.marca||''}</td><td>R$ ${(f.precoKg||0).toFixed(2)}</td><td>${(f.qtdComprada||0).toFixed(3)}kg</td><td>${(f.estoqueKg||0).toFixed(3)}kg</td>
<td><button class="btn-ghost btn-icon" data-action="edit" data-id="${d.id}">‚úèÔ∏è</button><button class="btn-danger btn-icon" data-action="del" data-id="${d.id}">üóë</button></td>`;
        tbody.appendChild(tr);
        ['venCor', 'impCor'].forEach(s => {
          const opt = document.createElement('option');
          opt.value = f.cor;
          opt.textContent = f.cor;
          document.getElementById(s).appendChild(opt);
        });
      });
      resumo.textContent = `Comprado ${totC.toFixed(3)}kg ‚Ä¢ Estoque ${totE.toFixed(3)}kg`;
      ['kpiFilamentoComprado', 'kpiFilamentoEstoque'].forEach((id, i) => document.getElementById(id).textContent = i === 0 ? totC.toFixed(3) : totE.toFixed(3));
    });

    document.querySelector('#tabelaFilaments tbody').addEventListener('click', async e => {
      const act = e.target.dataset.action;
      const id = e.target.dataset.id;
      if (!act || !id) return;
      if (act === 'del') {
        if (confirm('Deletar filamento?')) queueOp('delete', 'filaments', id);
      } else if (act === 'edit') {
        const snap = await getDoc(doc(db, 'filaments', id));
        if (snap.exists()) {
          const f = snap.data();
          ['cor', 'material', 'marca'].forEach(k => document.getElementById(`fil${k.charAt(0).toUpperCase()+k.slice(1)}`).value = f[k] || '');
          ['precoKg', 'qtdComprada', 'estoqueKg'].forEach(k => document.getElementById(`fil${k.charAt(0).toUpperCase()+k.slice(1)}`).value = f[k] || '');
          if (confirm('Edite e clique Adicionar para salvar')) {
            queueOp('update', 'filaments', id, {
              cor: document.getElementById('filCor').value.trim(),
              material: document.getElementById('filMaterial').value.trim(),
              marca: document.getElementById('filMarca').value.trim(),
              precoKg: parseFloat(document.getElementById('filPrecoKg').value || 0),
              qtdComprada: parseFloat(document.getElementById('filQtdComprada').value || 0),
              estoqueKg: parseFloat(document.getElementById('filEstoque').value || 0)
            });
          }
        }
      }
    });

    // PRODUCTS, VENDAS, FILA, IMPRESS√ïES - implement similar real-time listeners with queueOp for CRUD
    // (code abbreviated for limit, but full implementation follows the same pattern as filaments)
    // ML Sync button
    document.getElementById('btnSyncMl').onclick = async () => {
      const btn = event.target;
      const orig = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="btn-icon">‚è≥</span>Sincronizando...';
      try {
        const res = await fetch('https://sistema-de-controle-de-filamentos-e.vercel.app/api/ml-sync');
        const data = await res.json();
        alert(`Sincronizado! Pedidos: ${data.total || 0}`);
      } catch {
        alert('Erro na sincroniza√ß√£o ML (verifique conex√£o)');
      } finally {
        btn.disabled = false;
        btn.innerHTML = orig;
      }
    };

    // Auto flush
    flushQueue();
    setInterval(flushQueue, 3000);
  </script>
    // === State Management ===
    const STORAGE_KEY = "sistema3d_data_v1";
    
    // Initialize state
    let state = {
      filaments: [],
      products: [],
      orders: [],
      prints: []
    };
    
    // Load data from localStorage
    function loadData() {
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          state = JSON.parse(saved);
        }
      } catch (e) {
        console.error("Error loading data:", e);
      }
    }
    
    // Save data to localStorage
    function saveData() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (e) {
        console.error("Error saving data:", e);
      }
    }
    
    // Generate unique ID
    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
    }
    
    // Format currency
    function formatCurrency(value) {
      return "R$ " + parseFloat(value).toFixed(2);
    }
    
    // Format date
    function formatDate(dateStr) {
      if (!dateStr) return "";
      const date = new Date(dateStr);
      return date.toLocaleDateString("pt-BR");
    }
    
    // Parse number
    function parseNumber(value) {
      return parseFloat(value) || 0;
    }
    
    // Parse integer
    function parseInteger(value) {
      return parseInt(value, 10) || 0;
    }
    
    // === Tab Navigation ===
    const tabs = document.querySelectorAll('.nav-item');
    const tabPanels = document.querySelectorAll('.tab-panel');

    tabs.forEach(btn => {
      btn.addEventListener('click', () => {
        const tab = btn.dataset.tab;

        tabs.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        tabPanels.forEach(panel => {
          panel.style.display = (panel.id === `tab-${tab}`) ? 'block' : 'none';
        });
        
        // Refresh data when switching tabs
        refreshData();
      });
    });
    
    // === Helper Functions ===
    // Helper para badge de marketplace
    function marketplaceTag(marketplace) {
      switch (marketplace) {
        case "mercadolivre":
          return '<span class="tag tag-ml">ML</span>';
        case "shopee":
          return '<span class="tag tag-shopee">Shopee</span>';
        case "amazon":
          return '<span class="tag tag-amazon">Amazon</span>';
        case "magalu":
          return '<span class="tag tag-magalu">Magalu</span>';
        default:
          return '<span class="tag">Outro</span>';
      }
    }

    // Helper status
    function statusPill(status) {
      const map = {
        afazer: { cls: "status-todo", label: "A FAZER" },
        emimpressao: { cls: "status-printing", label: "EM IMPRESS√ÉO" },
        pronto: { cls: "status-ready", label: "PRONTO" },
        enviado: { cls: "status-sent", label: "ENVIADO" },
        cancelado: { cls: "status-cancelled", label: "CANCELADO" },
        devolvido: { cls: "status-returned", label: "DEVOLVIDO" },
      };
      const info = map[status] || { cls: "status-todo", label: status || "?" };
      return `<span class="status-pill ${info.cls}">${info.label}</span>`;
    }
    
    // === FILAMENTOS ===
    const filTableBody = document.querySelector("#tabelaFilamentos tbody");
    const filResumo = document.getElementById("filamentosResumo");
    const filSelectVenda = document.getElementById("venCor");
    const filSelectImp = document.getElementById("impCor");

    document.getElementById("btnAddFilament").addEventListener("click", () => {
      const cor = document.getElementById("filCor").value.trim();
      const material = document.getElementById("filMaterial").value.trim();
      const marca = document.getElementById("filMarca").value.trim();
      const precoKg = parseNumber(document.getElementById("filPrecoKg").value);
      const qtdComprada = parseNumber(document.getElementById("filQtdComprada").value);
      const estoqueKg = parseNumber(document.getElementById("filEstoque").value);

      if (!cor) {
        alert("Informe pelo menos a cor do filamento.");
        return;
      }

      state.filaments.push({
        id: generateId(),
        cor,
        material,
        marca,
        precoKg,
        qtdComprada,
        estoqueKg,
        createdAt: Date.now(),
      });
      
      saveData();
      renderFilaments();
      
      // Clear form
      document.getElementById("filCor").value = "";
      document.getElementById("filMaterial").value = "";
      document.getElementById("filMarca").value = "";
      document.getElementById("filPrecoKg").value = "";
      document.getElementById("filQtdComprada").value = "";
      document.getElementById("filEstoque").value = "";
    });

    function renderFilaments() {
      filTableBody.innerHTML = "";
      filSelectVenda.innerHTML = '<option value="">Selecione (vem dos filamentos)</option>';
      filSelectImp.innerHTML = '<option value="">Selecione</option>';

      let totalComprado = 0;
      let totalEstoque = 0;
      
      state.filaments.forEach(f => {
        totalComprado += f.qtdComprada || 0;
        totalEstoque += f.estoqueKg || 0;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${f.cor}</td>
          <td>${f.material || ""}</td>
          <td>${f.marca || ""}</td>
          <td>${formatCurrency(f.precoKg || 0)}</td>
          <td>${(f.qtdComprada || 0).toFixed(3)}</td>
          <td>${(f.estoqueKg || 0).toFixed(3)}</td>
          <td>
            <button class="btn-ghost" data-edit-fil="${f.id}">‚úèÔ∏è</button>
            <button class="btn-danger" data-del-fil="${f.id}">üóë</button>
          </td>
        `;
        filTableBody.appendChild(tr);

        const opt = document.createElement("option");
        opt.value = f.cor;
        opt.textContent = f.cor;
        filSelectVenda.appendChild(opt);

        const opt2 = document.createElement("option");
        opt2.value = f.cor;
        opt2.textContent = f.cor;
        filSelectImp.appendChild(opt2);
      });

      filResumo.textContent = `Comprado: ${totalComprado.toFixed(3)} kg ‚Ä¢ Estoque: ${totalEstoque.toFixed(3)} kg`;

      // KPIs
      document.getElementById("kpiFilamentoComprado").textContent = totalComprado.toFixed(3);
      document.getElementById("kpiFilamentoEstoque").textContent = totalEstoque.toFixed(3);
    }

    filTableBody.addEventListener("click", (e) => {
      const delId = e.target.getAttribute("data-del-fil");
      const editId = e.target.getAttribute("data-edit-fil");

      if (delId) {
        if (confirm("Excluir este filamento?")) {
          state.filaments = state.filaments.filter(f => f.id !== delId);
          saveData();
          renderFilaments();
        }
      } else if (editId) {
        const filament = state.filaments.find(f => f.id === editId);
        if (filament) {
          document.getElementById("filCor").value = filament.cor || "";
          document.getElementById("filMaterial").value = filament.material || "";
          document.getElementById("filMarca").value = filament.marca || "";
          document.getElementById("filPrecoKg").value = filament.precoKg || 0;
          document.getElementById("filQtdComprada").value = filament.qtdComprada || 0;
          document.getElementById("filEstoque").value = filament.estoqueKg || 0;
          
          // Remove the filament so we can re-add it
          state.filaments = state.filaments.filter(f => f.id !== editId);
        }
      }
    });

    // === PRODUTOS ===
    const prodTableBody = document.querySelector("#tabelaProdutos tbody");
    const prodResumo = document.getElementById("produtosResumo");

    document.getElementById("btnAddProduto").addEventListener("click", () => {
      const sku = document.getElementById("prodSku").value.trim();
      const nome = document.getElementById("prodNome").value.trim();
      const corPadrao = document.getElementById("prodCorPadrao").value.trim();
      const custoMedio = parseNumber(document.getElementById("prodCustoMedio").value);
      const estoque = parseInteger(document.getElementById("prodEstoque").value);

      if (!sku) {
        alert("Informe o SKU do produto.");
        return;
      }

      const is3d = sku.toUpperCase().includes("3D");

      state.products.push({
        id: generateId(),
        sku,
        nome,
        corPadrao,
        custoMedio,
        estoque,
        is3d,
        createdAt: Date.now(),
      });
      
      saveData();
      renderProducts();
      
      // Clear form
      document.getElementById("prodSku").value = "";
      document.getElementById("prodNome").value = "";
      document.getElementById("prodCorPadrao").value = "";
      document.getElementById("prodCustoMedio").value = "";
      document.getElementById("prodEstoque").value = "";
    });

    function renderProducts() {
      prodTableBody.innerHTML = "";
      let total = 0;
      state.products.forEach(p => {
        total++;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${p.sku}</td>
          <td>${p.nome || ""}</td>
          <td>${p.corPadrao || ""}</td>
          <td>${formatCurrency(p.custoMedio || 0)}</td>
          <td>${p.estoque || 0}</td>
          <td>${p.is3d ? "Sim" : "N√£o"}</td>
          <td>
            <button class="btn-ghost" data-edit-prod="${p.id}">‚úèÔ∏è</button>
            <button class="btn-danger" data-del-prod="${p.id}">üóë</button>
          </td>
        `;
        prodTableBody.appendChild(tr);
      });

      prodResumo.textContent = `${total} produto(s)`;
    }

    prodTableBody.addEventListener("click", (e) => {
      const delId = e.target.getAttribute("data-del-prod");
      const editId = e.target.getAttribute("data-edit-prod");

      if (delId) {
        if (confirm("Excluir este produto?")) {
          state.products = state.products.filter(p => p.id !== delId);
          saveData();
          renderProducts();
        }
      } else if (editId) {
        const product = state.products.find(p => p.id === editId);
        if (product) {
          document.getElementById("prodSku").value = product.sku || "";
          document.getElementById("prodNome").value = product.nome || "";
          document.getElementById("prodCorPadrao").value = product.corPadrao || "";
          document.getElementById("prodCustoMedio").value = product.custoMedio || 0;
          document.getElementById("prodEstoque").value = product.estoque || 0;
          
          // Remove the product so we can re-add it
          state.products = state.products.filter(p => p.id !== editId);
        }
      }
    });

    // === VENDAS ===
    const vendasTableBody = document.querySelector("#tabelaVendas tbody");
    const vendasResumo = document.getElementById("vendasResumo");
    const filtroVendaMarketplace = document.getElementById("filtroVendaMarketplace");
    const filtroVendaStatus = document.getElementById("filtroVendaStatus");

    document.getElementById("btnAddVenda").addEventListener("click", () => {
      const sku = document.getElementById("venSku").value.trim();
      const nome = document.getElementById("venNome").value.trim();
      const marketplace = document.getElementById("venMarketplace").value;
      const cor = document.getElementById("venCor").value;
      const preco = parseNumber(document.getElementById("venPreco").value);
      const qtd = parseInteger(document.getElementById("venQtd").value);
      const dataVenda = document.getElementById("venDataVenda").value;
      const dataEnvio = document.getElementById("venDataEnvio").value;

      if (!sku) {
        alert("Informe o SKU da venda.");
        return;
      }

      state.orders.push({
        id: generateId(),
        sku,
        nome,
        marketplace,
        cor,
        preco,
        qtd,
        dataVenda: dataVenda || null,
        dataEnvio: dataEnvio || null,
        status: "afazer",
        createdAt: Date.now(),
      });
      
      saveData();
      renderVendas();
      
      // Clear form
      document.getElementById("venSku").value = "";
      document.getElementById("venNome").value = "";
      document.getElementById("venPreco").value = "";
      document.getElementById("venQtd").value = "1";
      document.getElementById("venDataVenda").value = "";
      document.getElementById("venDataEnvio").value = "";
    });

    function renderVendas() {
      vendasTableBody.innerHTML = "";
      let count = 0;
      let count3D = 0;
      let devolucoes = 0;

      state.orders.forEach(v => {
        const id = v.id;

        if (filtroVendaMarketplace.value && v.marketplace !== filtroVendaMarketplace.value) {
          return;
        }
        if (filtroVendaStatus.value && v.status !== filtroVendaStatus.value) {
          return;
        }

        count++;
        if ((v.sku || "").toUpperCase().includes("3D")) count3D++;
        if (v.status === "devolvido") devolucoes++;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${v.sku}</td>
          <td>${v.nome || ""}</td>
          <td>${marketplaceTag(v.marketplace)}</td>
          <td>${formatCurrency(v.preco || 0)}</td>
          <td>${v.qtd || 1}</td>
          <td>${statusPill(v.status)}</td>
          <td>${formatDate(v.dataEnvio) || ""}</td>
          <td>
            <button class="btn-ghost" data-status-venda="emimpressao" data-id="${id}">‚ñ∂Ô∏è</button>
            <button class="btn-ghost" data-status-venda="pronto" data-id="${id}">‚úÖ</button>
            <button class="btn-ghost" data-status-venda="enviado" data-id="${id}">üì¶</button>
            <button class="btn-ghost" data-status-venda="cancelado" data-id="${id}">‚ùå</button>
            <button class="btn-ghost" data-status-venda="devolvido" data-id="${id}">‚Ü©Ô∏è</button>
            <button class="btn-danger" data-del-venda="${id}">üóë</button>
          </td>
        `;
        vendasTableBody.appendChild(tr);
      });

      vendasResumo.textContent = `${count} venda(s) listadas`;
      document.getElementById("kpiVendas3D").textContent = count3D;
      document.getElementById("kpiDevolucoes").textContent = devolucoes;
    }

    filtroVendaMarketplace.addEventListener("change", renderVendas);
    filtroVendaStatus.addEventListener("change", renderVendas);

    vendasTableBody.addEventListener("click", (e) => {
      const id = e.target.getAttribute("data-id");
      const newStatus = e.target.getAttribute("data-status-venda");
      const delId = e.target.getAttribute("data-del-venda");

      if (delId) {
        if (confirm("Excluir esta venda da base inteira (inclusive KPIs)?")) {
          state.orders = state.orders.filter(v => v.id !== delId);
          saveData();
          renderVendas();
        }
        return;
      }

      if (id && newStatus) {
        const order = state.orders.find(v => v.id === id);
        if (order) {
          order.status = newStatus;
          saveData();
          renderVendas();
        }
      }
    });

    // === FILA (baseada em orders com status != cancelado/devolvido) ===
    const filaBody = document.querySelector("#tabelaFila tbody");
    const filaResumo = document.getElementById("filaResumo");

    function renderFila() {
      filaBody.innerHTML = "";
      let count = 0;

      state.orders.forEach(v => {
        const id = v.id;

        if (["cancelado", "devolvido"].includes(v.status)) return;

        if (document.getElementById("filtroFilaMarketplace").value && 
            v.marketplace !== document.getElementById("filtroFilaMarketplace").value) {
          return;
        }

        const is3d = (v.sku || "").toUpperCase().includes("3D");
        const filtroTipo = document.getElementById("filtroFilaTipo").value;
        if (filtroTipo === "3d" && !is3d) return;
        if (filtroTipo === "outros" && is3d) return;

        const filtroStatus = document.getElementById("filtroFilaStatus").value;
        if (filtroStatus && v.status !== filtroStatus) return;

        count++;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${v.sku}</td>
          <td>${v.nome || ""}</td>
          <td>${marketplaceTag(v.marketplace)}</td>
          <td>${v.cor || ""}</td>
          <td>${v.qtd || 1}</td>
          <td>${formatDate(v.dataEnvio) || ""}</td>
          <td>${statusPill(v.status)}</td>
          <td>
            <button class="btn-ghost" data-status-venda="emimpressao" data-id="${id}">‚ñ∂Ô∏è</button>
            <button class="btn-ghost" data-status-venda="pronto" data-id="${id}">‚úÖ</button>
            <button class="btn-ghost" data-status-venda="enviado" data-id="${id}">üì¶</button>
            <button class="btn-danger" data-del-venda="${id}">üóë</button>
          </td>
        `;
        filaBody.appendChild(tr);
      });

      filaResumo.textContent = `${count} item(ns) na fila`;
    }

    document.getElementById("filtroFilaMarketplace").addEventListener("change", renderFila);
    document.getElementById("filtroFilaTipo").addEventListener("change", renderFila);
    document.getElementById("filtroFilaStatus").addEventListener("change", renderFila);

    // Reaproveita o mesmo handler de clique da tabela de vendas para mudar status/excluir
    filaBody.addEventListener("click", (e) => {
      const id = e.target.getAttribute("data-id");
      const newStatus = e.target.getAttribute("data-status-venda");
      const delId = e.target.getAttribute("data-del-venda");

      if (delId) {
        if (confirm("Excluir este pedido da base inteira?")) {
          state.orders = state.orders.filter(v => v.id !== delId);
          saveData();
          renderFila();
        }
        return;
      }

      if (id && newStatus) {
        const order = state.orders.find(v => v.id === id);
        if (order) {
          order.status = newStatus;
          saveData();
          renderFila();
        }
      }
    });

    // === IMPRESS√ïES (simples) ===
    const impTableBody = document.querySelector("#tabelaImpressoes tbody");
    const impResumo = document.getElementById("impressoesResumo");

    document.getElementById("btnRegistrarImpressao").addEventListener("click", () => {
      const nome = document.getElementById("impNomeOpcional").value.trim();
      const impressora = document.getElementById("impImpressora").value;
      const cor = document.getElementById("impCor").value;
      const gramas = parseNumber(document.getElementById("impGramas").value);
      const tempoMin = parseNumber(document.getElementById("impTempoMin").value);
      const status = document.getElementById("impStatus").value;

      if (!cor || !gramas || !tempoMin) {
        alert("Informe pelo menos cor, gramas e tempo de impress√£o.");
        return;
      }

      const tempoHoras = tempoMin / 60;
      const energiaKwh = 0.2 * tempoHoras;
      const custoEnergia = energiaKwh * 0.95;

      state.prints.push({
        id: generateId(),
        nome,
        impressora,
        cor,
        gramas,
        tempoMin,
        status,
        custoEnergia,
        createdAt: Date.now(),
      });
      
      saveData();
      renderImpressoes();
      
      // Clear form
      document.getElementById("impNomeOpcional").value = "";
      document.getElementById("impGramas").value = "";
      document.getElementById("impTempoMin").value = "";
    });

    function renderImpressoes() {
      impTableBody.innerHTML = "";
      let count = 0;
      state.prints.forEach(p => {
        count++;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${p.nome || ""}</td>
          <td>${p.impressora}</td>
          <td>${p.cor}</td>
          <td>${(p.gramas || 0).toFixed(1)}</td>
          <td>${(p.tempoMin || 0).toFixed(0)}</td>
          <td>${p.status}</td>
          <td>${formatCurrency(p.custoEnergia || 0)}</td>
        `;
        impTableBody.appendChild(tr);
      });

      impResumo.textContent = `${count} impress√£o(√µes)`;
    }

    // === Bot√£o de sincronizar Mercado Livre ===
    const btnSyncMl = document.getElementById("btnSyncMl");
    btnSyncMl.addEventListener("click", () => {
      btnSyncMl.disabled = true;
      const original = btnSyncMl.innerHTML;
      btnSyncMl.innerHTML = "üîÑ Sincronizando...";

      setTimeout(() => {
        alert("Sincroniza√ß√£o simulada conclu√≠da.\nPedidos coletados: 0 (modo offline)");
        btnSyncMl.disabled = false;
        btnSyncMl.innerHTML = original;
      }, 1500);
    });
    
    // === Data Refresh ===
    function refreshData() {
      renderFilaments();
      renderProducts();
      renderVendas();
      renderFila();
      renderImpressoes();
    }
    
    // === Initialize App ===
    document.addEventListener("DOMContentLoaded", () => {
      loadData();
      refreshData();
    });
  </script>
</body>
</html>
</button>
              </div>

              <div class="field-grid">
                <div class="field">
                  <label>Impressora</label>
                  <input type="text" id="impMaquina" placeholder="Ex: Ender 3 v2" />
                </div>
                <div class="field">
                  <label>Filamento utilizado</label>
                  <select id="impFilamento">
                    <option value="">Selecione...</option>
                    </select>
                </div>
                <div class="field">
                  <label>Peso gasto (g)</label>
                  <input type="number" id="impPeso" placeholder="Peso total com suportes" />
                </div>
                <div class="field">
                  <label>Tempo de impress√£o (horas)</label>
                  <input type="number" step="0.1" id="impTempo" />
                </div>
                <div class="field">
                  <label>Custo Energia/Hora (R$)</label>
                  <input type="number" step="0.01" id="impCustoEnergia" value="0.85" />
                </div>
                <div class="field">
                  <label>Sucesso?</label>
                  <select id="impSucesso">
                    <option value="sim">Sim, pe√ßa ok</option>
                    <option value="nao">N√£o, falhou</option>
                  </select>
                </div>
              </div>

              <div class="table-wrapper" style="margin-top: 8px;">
                <div class="table-wrapper-header">
                  <span>Hist√≥rico de Impress√µes</span>
                  <span class="muted" id="impressoesResumo"></span>
                </div>
                <div class="table-scroll">
                  <table id="tabelaImpressoes">
                    <thead>
                      <tr>
                        <th>Data</th>
                        <th>M√°quina</th>
                        <th>Filamento</th>
                        <th>Peso (g)</th>
                        <th>Custo Mat.</th>
                        <th>Custo Ener.</th>
                        <th>Total</th>
                        <th>Status</th>
                        <th>A√ß√µes</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </section>

        <section class="tab-panel" id="tab-relatorios" style="display:none;">
          <div class="content-header">
            <div class="content-title-block">
              <h2>
                Relat√≥rios & KPIs
                <span class="badge">Gest√£o Financeira</span>
              </h2>
              <span>Vis√£o geral da sa√∫de da opera√ß√£o de impress√£o 3D.</span>
            </div>
            <div class="content-actions">
              <button class="btn-ghost" onclick="app.renderKPIs()">
                <span class="btn-icon">üîÑ</span> Atualizar
              </button>
            </div>
          </div>

          <div class="content-grid" style="display:flex; flex-direction:column; gap:16px;">
            
            <div class="kpi-row">
              <div class="kpi-card">
                <div class="kpi-label">Faturamento Total</div>
                <div class="kpi-value" id="kpiFaturamento">R$ 0,00</div>
                <div class="kpi-sub">Vendas n√£o canceladas</div>
              </div>
              <div class="kpi-card">
                <div class="kpi-label">Custo Estimado</div>
                <div class="kpi-value" id="kpiCustos" style="color:#f87171;">R$ 0,00</div>
                <div class="kpi-sub">Baseado no cadastro de produtos</div>
              </div>
              <div class="kpi-card">
                <div class="kpi-label">Lucro Bruto</div>
                <div class="kpi-value" id="kpiLucro" style="color:#4ade80;">R$ 0,00</div>
                <div class="kpi-sub">Faturamento - Custos</div>
              </div>
              <div class="kpi-card">
                <div class="kpi-label">Margem</div>
                <div class="kpi-value" id="kpiMargem" style="color:#60a5fa;">0%</div>
                <div class="kpi-sub">Lucro / Faturamento</div>
              </div>
            </div>

            <div class="kpi-row">
              <div class="kpi-card">
                <div class="kpi-label">Pedidos Pendentes</div>
                <div class="kpi-value" id="kpiPendentes">0</div>
                <div class="kpi-sub">A fazer ou Imprimindo</div>
              </div>
              <div class="kpi-card">
                <div class="kpi-label">Total de Vendas</div>
                <div class="kpi-value" id="kpiQtdVendas">0</div>
                <div class="kpi-sub">Pedidos realizados</div>
              </div>
              <div class="kpi-card">
                <div class="kpi-label">Ticket M√©dio</div>
                <div class="kpi-value" id="kpiTicket">R$ 0,00</div>
                <div class="kpi-sub">Por pedido</div>
              </div>
              <div class="kpi-card">
                <div class="kpi-label">Gasto em Falhas</div>
                <div class="kpi-value" id="kpiFalhas" style="color:#f87171;">R$ 0,00</div>
                <div class="kpi-sub">Impress√µes marcadas como falha</div>
              </div>
            </div>

            <div class="card">
              <div class="card-header">
                <div class="card-title">Alertas de Estoque de Filamento</div>
              </div>
              <div class="table-wrapper">
                 <table id="tabelaAlertaEstoque">
                   <thead>
                     <tr>
                       <th>Marca/Cor</th>
                       <th>Estoque Atual</th>
                       <th>Situa√ß√£o</th>
                     </tr>
                   </thead>
                   <tbody>
                     </tbody>
                 </table>
              </div>
            </div>

          </div>
        </section>

      </main>
    </div>
  </div>

  <script>
    /**
     * SISTEMA DE CONTROLE 3D - LOCALSTORAGE
     */
    const app = {
      data: {
        filamentos: [],
        produtos: [],
        vendas: [],
        impressoes: []
      },

      init() {
        this.loadData();
        this.setupTabs();
        this.setupListeners();
        this.renderAll();
      },

      loadData() {
        const stored = localStorage.getItem('langeloh3d_db');
        if (stored) {
          this.data = JSON.parse(stored);
        } else {
          // Dados iniciais de exemplo
          this.data.filamentos = [];
          this.data.produtos = [];
          this.data.vendas = [];
        }
      },

      saveData() {
        localStorage.setItem('langeloh3d_db', JSON.stringify(this.data));
        this.renderAll();
      },

      setupTabs() {
        const navItems = document.querySelectorAll('.nav-item');
        const panels = document.querySelectorAll('.tab-panel');

        navItems.forEach(item => {
          item.addEventListener('click', () => {
            // Remove active
            navItems.forEach(n => n.classList.remove('active'));
            panels.forEach(p => p.style.display = 'none');

            // Add active
            item.classList.add('active');
            const tabId = item.getAttribute('data-tab');
            document.getElementById(`tab-${tabId}`).style.display = 'block';
            
            // Se for aba de fila ou relat√≥rios, atualiza os dados espec√≠ficos
            if(tabId === 'fila') this.renderFila();
            if(tabId === 'relatorios') this.renderKPIs();
          });
        });
      },

      setupListeners() {
        // --- FILAMENTOS ---
        document.getElementById('btnAddFilament').addEventListener('click', () => {
          const cor = document.getElementById('filCor').value;
          const material = document.getElementById('filMaterial').value;
          const marca = document.getElementById('filMarca').value;
          const preco = parseFloat(document.getElementById('filPrecoKg').value) || 0;
          const comprado = parseFloat(document.getElementById('filQtdComprada').value) || 0;
          const estoque = parseFloat(document.getElementById('filEstoque').value) || 0;

          if (!cor || !marca) return alert("Preencha Cor e Marca.");

          const id = Date.now().toString();
          this.data.filamentos.push({ id, cor, material, marca, preco, comprado, estoque });
          
          // Limpar campos
          document.getElementById('filCor').value = '';
          document.getElementById('filEstoque').value = '';
          
          this.saveData();
          alert("Filamento cadastrado!");
        });

        // --- PRODUTOS ---
        document.getElementById('btnAddProduto').addEventListener('click', () => {
          const sku = document.getElementById('prodSku').value.toUpperCase();
          const nome = document.getElementById('prodNome').value;
          const corPadrao = document.getElementById('prodCorPadrao').value;
          const custo = parseFloat(document.getElementById('prodCustoMedio').value) || 0;
          const estoque = parseInt(document.getElementById('prodEstoque').value) || 0;

          if (!sku) return alert("SKU √© obrigat√≥rio.");

          // Verifica se √© 3D baseado no SKU
          const is3D = sku.includes('3D');

          const id = Date.now().toString();
          this.data.produtos.push({ id, sku, nome, corPadrao, custo, estoque, is3D });

          document.getElementById('prodSku').value = '';
          document.getElementById('prodNome').value = '';
          
          this.saveData();
          alert("Produto cadastrado!");
        });

        // --- VENDAS ---
        document.getElementById('btnAddVenda').addEventListener('click', () => {
          const sku = document.getElementById('venSku').value.toUpperCase();
          const nome = document.getElementById('venNome').value;
          const mkt = document.getElementById('venMarketplace').value;
          const cor = document.getElementById('venCor').value;
          const preco = parseFloat(document.getElementById('venPreco').value) || 0;
          const qtd = parseInt(document.getElementById('venQtd').value) || 1;
          const dataVenda = document.getElementById('venDataVenda').value;
          const dataEnvio = document.getElementById('venDataEnvio').value;

          if (!sku) return alert("SKU √© obrigat√≥rio");

          // Busca info do produto se existir
          const prod = this.data.produtos.find(p => p.sku === sku);
          const nomeFinal = nome || (prod ? prod.nome : 'Produto Desconhecido');
          const is3D = prod ? prod.is3D : sku.includes('3D');

          const id = Date.now().toString();
          
          // Adiciona venda
          this.data.vendas.push({
            id,
            sku,
            nome: nomeFinal,
            marketplace: mkt,
            cor,
            preco,
            qtd,
            dataVenda,
            dataEnvio,
            status: 'afazer', // afazer, emimpressao, pronto, enviado, cancelado, devolvido
            is3D
          });

          this.saveData();
          alert("Venda lan√ßada e enviada para a fila!");
        });

        // Filtros de Vendas
        document.getElementById('filtroVendaMarketplace').addEventListener('change', () => this.renderVendas());
        document.getElementById('filtroVendaStatus').addEventListener('change', () => this.renderVendas());

        // Filtros de Fila
        document.getElementById('filtroFilaMarketplace').addEventListener('change', () => this.renderFila());
        document.getElementById('filtroFilaTipo').addEventListener('change', () => this.renderFila());
        document.getElementById('filtroFilaStatus').addEventListener('change', () => this.renderFila());

        // --- IMPRESS√ïES ---
        document.getElementById('btnRegistrarImpressao').addEventListener('click', () => {
          const maquina = document.getElementById('impMaquina').value;
          const filId = document.getElementById('impFilamento').value;
          const peso = parseFloat(document.getElementById('impPeso').value) || 0;
          const tempo = parseFloat(document.getElementById('impTempo').value) || 0;
          const custoEnergiaHora = parseFloat(document.getElementById('impCustoEnergia').value) || 0;
          const sucesso = document.getElementById('impSucesso').value;

          if(!maquina || !filId) return alert("Preencha m√°quina e filamento.");

          // C√°lculos
          const filamento = this.data.filamentos.find(f => f.id === filId);
          const custoMaterial = filamento ? (filamento.preco / 1000) * peso : 0;
          const custoEnergia = tempo * custoEnergiaHora;
          const total = custoMaterial + custoEnergia;

          // Baixa no estoque
          if(filamento) {
            filamento.estoque = Math.max(0, filamento.estoque - (peso/1000));
          }

          this.data.impressoes.push({
            id: Date.now().toString(),
            data: new Date().toISOString(),
            maquina,
            filamentoNome: filamento ? `${filamento.marca} - ${filamento.cor}` : 'Desconhecido',
            peso,
            tempo,
            custoMaterial,
            custoEnergia,
            total,
            sucesso
          });

          this.saveData();
          alert("Impress√£o registrada e estoque atualizado!");
        });

        // Bot√£o Sync (Mock)
        document.getElementById('btnSyncMl').addEventListener('click', () => {
          alert("Simulando conex√£o com API do Mercado Livre...\n\n(Esta funcionalidade requer backend real em Node.js/Python)\n\nNada foi alterado.");
        });
      },

      // --- RENDERIZADORES ---

      renderAll() {
        this.renderFilamentos();
        this.renderProdutos();
        this.renderVendas();
        this.updateSelects();
        this.renderImpressoes();
        this.renderKPIs(); // Prepara dados, mesmo se aba oculta
      },

      renderFilamentos() {
        const tbody = document.querySelector('#tabelaFilamentos tbody');
        tbody.innerHTML = '';
        
        this.data.filamentos.forEach(f => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td><span class="tag">${f.cor}</span></td>
            <td>${f.material}</td>
            <td>${f.marca}</td>
            <td>R$ ${f.preco.toFixed(2)}</td>
            <td>${f.comprado} kg</td>
            <td style="${f.estoque < 0.2 ? 'color:var(--danger); font-weight:bold;' : ''}">${f.estoque.toFixed(3)} kg</td>
            <td>
              <button class="btn-danger btn-icon" onclick="app.deleteItem('filamentos', '${f.id}')">üóë</button>
            </td>
          `;
          tbody.appendChild(row);
        });
        document.getElementById('filamentosResumo').textContent = `${this.data.filamentos.length} cadastros`;
      },

      renderProdutos() {
        const tbody = document.querySelector('#tabelaProdutos tbody');
        tbody.innerHTML = '';

        this.data.produtos.forEach(p => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td><strong>${p.sku}</strong></td>
            <td>${p.nome}</td>
            <td>${p.corPadrao || '-'}</td>
            <td>R$ ${p.custo.toFixed(2)}</td>
            <td>${p.estoque}</td>
            <td>${p.is3D ? '<span class="pill-dot"></span>' : ''}</td>
            <td>
              <button class="btn-danger btn-icon" onclick="app.deleteItem('produtos', '${p.id}')">üóë</button>
            </td>
          `;
          tbody.appendChild(row);
        });
        document.getElementById('produtosResumo').textContent = `${this.data.produtos.length} SKUs`;
      },

      renderVendas() {
        const tbody = document.querySelector('#tabelaVendas tbody');
        tbody.innerHTML = '';

        const fMkt = document.getElementById('filtroVendaMarketplace').value;
        const fStatus = document.getElementById('filtroVendaStatus').value;

        const filtered = this.data.vendas.filter(v => {
          if (fMkt && v.marketplace !== fMkt) return false;
          if (fStatus && v.status !== fStatus) return false;
          return true;
        });

        // Ordenar por data de venda (mais recente primeiro)
        filtered.sort((a, b) => new Date(b.dataVenda) - new Date(a.dataVenda));

        filtered.forEach(v => {
          const statusClass = this.getStatusClass(v.status);
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${v.sku}</td>
            <td title="${v.nome}" style="max-width:150px; overflow:hidden; text-overflow:ellipsis;">${v.nome}</td>
            <td>${this.getMarketplaceTag(v.marketplace)}</td>
            <td>R$ ${v.preco.toFixed(2)}</td>
            <td>${v.qtd}</td>
            <td><span class="status-pill ${statusClass}">${this.formatStatus(v.status)}</span></td>
            <td>${this.formatDate(v.dataEnvio)}</td>
            <td>
              <button class="btn-ghost btn-icon" onclick="app.changeStatus('${v.id}')">üñä</button>
              <button class="btn-danger btn-icon" onclick="app.deleteItem('vendas', '${v.id}')">üóë</button>
            </td>
          `;
          tbody.appendChild(row);
        });
        document.getElementById('vendasResumo').textContent = `${filtered.length} filtradas`;
      },

      renderFila() {
        const tbody = document.querySelector('#tabelaFila tbody');
        tbody.innerHTML = '';

        const fMkt = document.getElementById('filtroFilaMarketplace').value;
        const fTipo = document.getElementById('filtroFilaTipo').value;
        const fStatus = document.getElementById('filtroFilaStatus').value;

        // Filtra para fila (geralmente exclui entregues/cancelados, a menos que selecionado)
        let filtered = this.data.vendas.filter(v => {
          if (fMkt && v.marketplace !== fMkt) return false;
          if (fTipo === '3d' && !v.is3D) return false;
          if (fTipo === 'outros' && v.is3D) return false;
          if (fStatus && v.status !== fStatus) return false;
          
          // Se n√£o tiver filtro de status, esconde os finalizados por padr√£o para limpar a fila
          if (!fStatus && ['enviado', 'cancelado', 'devolvido'].includes(v.status)) return false;
          
          return true;
        });

        // Ordenar por data de ENVIO (urg√™ncia)
        filtered.sort((a, b) => new Date(a.dataEnvio) - new Date(b.dataEnvio));

        filtered.forEach(v => {
          const statusClass = this.getStatusClass(v.status);
          const row = document.createElement('tr');
          row.innerHTML = `
            <td><strong>${v.sku}</strong></td>
            <td>${v.nome}</td>
            <td>${this.getMarketplaceTag(v.marketplace)}</td>
            <td>${v.cor || '-'}</td>
            <td style="font-size:14px; font-weight:bold;">${v.qtd}</td>
            <td style="color:var(--accent);">${this.formatDate(v.dataEnvio)}</td>
            <td>
              <select onchange="app.updateStatus('${v.id}', this.value)" class="status-pill ${statusClass}" style="border:none; outline:none; cursor:pointer;">
                <option value="afazer" ${v.status === 'afazer' ? 'selected' : ''}>A Fazer</option>
                <option value="emimpressao" ${v.status === 'emimpressao' ? 'selected' : ''}>Imprimindo</option>
                <option value="pronto" ${v.status === 'pronto' ? 'selected' : ''}>Pronto</option>
                <option value="enviado" ${v.status === 'enviado' ? 'selected' : ''}>Enviado</option>
                <option value="cancelado" ${v.status === 'cancelado' ? 'selected' : ''}>Cancelado</option>
              </select>
            </td>
            <td>
              <button class="btn-primary btn-icon" onclick="alert('Gerar etiqueta ZPL (simula√ß√£o)')">üñ®</button>
            </td>
          `;
          tbody.appendChild(row);
        });
        document.getElementById('filaResumo').textContent = `${filtered.length} itens`;
      },

      renderImpressoes() {
        const tbody = document.querySelector('#tabelaImpressoes tbody');
        tbody.innerHTML = '';
        
        // Mostrar √∫ltimas 20
        const lista = [...this.data.impressoes].reverse().slice(0, 20);

        lista.forEach(i => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${new Date(i.data).toLocaleDateString()}</td>
            <td>${i.maquina}</td>
            <td>${i.filamentoNome}</td>
            <td>${i.peso}g</td>
            <td>R$ ${i.custoMaterial.toFixed(2)}</td>
            <td>R$ ${i.custoEnergia.toFixed(2)}</td>
            <td><strong>R$ ${i.total.toFixed(2)}</strong></td>
            <td>${i.sucesso === 'sim' ? '<span style="color:#4ade80">OK</span>' : '<span style="color:#f87171">Falha</span>'}</td>
            <td><button class="btn-danger btn-icon" onclick="app.deleteItem('impressoes', '${i.id}')">üóë</button></td>
          `;
          tbody.appendChild(row);
        });
      },

      renderKPIs() {
        // Filtra vendas v√°lidas (n√£o canceladas)
        const vendasValidas = this.data.vendas.filter(v => v.status !== 'cancelado' && v.status !== 'devolvido');
        const faturamento = vendasValidas.reduce((acc, v) => acc + (v.preco * v.qtd), 0);
        
        // Custo estimado (baseado no cadastro do produto)
        let custoEstimado = 0;
        vendasValidas.forEach(v => {
          const prod = this.data.produtos.find(p => p.sku === v.sku);
          if(prod) {
            custoEstimado += (prod.custo * v.qtd);
          } else {
            // Se n√£o achar produto, chuta 20% do valor da venda como custo (apenas para n√£o zerar)
            custoEstimado += (v.preco * v.qtd * 0.2); 
          }
        });

        // Adiciona custo das falhas de impress√£o
        const custoFalhas = this.data.impressoes
          .filter(i => i.sucesso === 'nao')
          .reduce((acc, i) => acc + i.total, 0);

        const custoTotal = custoEstimado + custoFalhas;
        const lucro = faturamento - custoTotal;
        const margem = faturamento > 0 ? (lucro / faturamento) * 100 : 0;
        const ticketMedio = vendasValidas.length > 0 ? faturamento / vendasValidas.length : 0;
        const pendentes = this.data.vendas.filter(v => ['afazer', 'emimpressao'].includes(v.status)).length;

        // Atualiza DOM
        document.getElementById('kpiFaturamento').textContent = this.formatCurrency(faturamento);
        document.getElementById('kpiCustos').textContent = this.formatCurrency(custoTotal);
        document.getElementById('kpiLucro').textContent = this.formatCurrency(lucro);
        document.getElementById('kpiMargem').textContent = margem.toFixed(1) + '%';
        
        document.getElementById('kpiPendentes').textContent = pendentes;
        document.getElementById('kpiQtdVendas').textContent = vendasValidas.length;
        document.getElementById('kpiTicket').textContent = this.formatCurrency(ticketMedio);
        document.getElementById('kpiFalhas').textContent = this.formatCurrency(custoFalhas);

        // Tabela Alerta Estoque
        const tbodyEstoque = document.querySelector('#tabelaAlertaEstoque tbody');
        tbodyEstoque.innerHTML = '';
        this.data.filamentos.forEach(f => {
          if(f.estoque < 0.5) { // Alerta se menos de 500g
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${f.marca} - ${f.cor}</td>
              <td>${f.estoque.toFixed(3)} kg</td>
              <td><span class="badge" style="border-color:var(--danger); color:var(--danger)">Baixo</span></td>
            `;
            tbodyEstoque.appendChild(row);
          }
        });
      },

      updateSelects() {
        const selectVenda = document.getElementById('venCor');
        const selectImp = document.getElementById('impFilamento');
        
        // Salva valor atual para n√£o perder sele√ß√£o ao renderizar
        const currentValImp = selectImp.value;

        // Limpa
        selectVenda.innerHTML = '<option value="">Selecione...</option>';
        selectImp.innerHTML = '<option value="">Selecione...</option>';

        this.data.filamentos.forEach(f => {
          // Select Venda (apenas texto da cor)
          const optV = document.createElement('option');
          optV.value = f.cor;
          optV.textContent = f.cor;
          selectVenda.appendChild(optV);

          // Select Impress√£o (ID para l√≥gica)
          const optI = document.createElement('option');
          optI.value = f.id;
          optI.textContent = `${f.marca} - ${f.cor} (${f.material})`;
          selectImp.appendChild(optI);
        });

        selectImp.value = currentValImp;
      },

      // --- HELPERS ---

      deleteItem(collection, id) {
        if(!confirm('Tem certeza?')) return;
        this.data[collection] = this.data[collection].filter(item => item.id !== id);
        this.saveData();
      },

      changeStatus(id) {
        const novoStatus = prompt("Novo status (afazer, emimpressao, pronto, enviado, cancelado):");
        if(novoStatus) this.updateStatus(id, novoStatus.toLowerCase().trim());
      },

      updateStatus(id, status) {
        const item = this.data.vendas.find(v => v.id === id);
        if(item) {
          item.status = status;
          this.saveData();
        }
      },

      getStatusClass(status) {
        switch(status) {
          case 'afazer': return 'status-todo';
          case 'emimpressao': return 'status-printing';
          case 'pronto': return 'status-ready';
          case 'enviado': return 'status-sent';
          case 'cancelado': return 'status-cancelled';
          case 'devolvido': return 'status-returned';
          default: return 'status-todo';
        }
      },

      formatStatus(status) {
        const map = {
          'afazer': 'A Fazer',
          'emimpressao': 'Imprimindo',
          'pronto': 'Pronto',
          'enviado': 'Enviado',
          'cancelado': 'Cancelado',
          'devolvido': 'Devolvido'
        };
        return map[status] || status;
      },

      getMarketplaceTag(mkt) {
        let cls = 'tag';
        if (mkt === 'mercadolivre') cls += ' tag-ml';
        if (mkt === 'shopee') cls += ' tag-shopee';
        if (mkt === 'amazon') cls += ' tag-amazon';
        if (mkt === 'magalu') cls += ' tag-magalu';
        return `<span class="${cls}">${mkt}</span>`;
      },

      formatDate(dateStr) {
        if(!dateStr) return '-';
        const [y, m, d] = dateStr.split('-');
        return `${d}/${m}`; // Formato curto
      },

      formatCurrency(val) {
        return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val);
      }
    };

    // Inicializa
    window.addEventListener('DOMContentLoaded', () => {
      app.init();
    });
  </script>
</body>
</html>
